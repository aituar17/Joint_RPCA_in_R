---
title: "IBDMDB — Joint-RPCA Benchmarking"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

#necessary imports
library(Matrix)
library(tidyr)
library(ggplot2)
library(vegan)
library(MultiAssayExperiment)
library(pROC)
library(dplyr, warn.conflicts = FALSE)
library(mia)

#load the necessary functions
source("../R/jointRPCA.R")
source("../R/utils.R")
source("../R/optspace.R")

#paths
f_mgx <- "data_ibdmdb_raw/taxonomic_profiles_mgx.tsv"     #metagenomics
f_mtx <- "data_ibdmdb_raw/ecs_relab.tsv"                  #metatranscriptomics
f_meta <- "data_ibdmdb_raw/hmp2_metadata_2018-08-20.csv"  #HMP2/IBDMDB master metadata

read_ibdmdb_tsv <- function(path) {
  stopifnot(file.exists(path))
  first <- readLines(path, n = 200L, warn = FALSE)
  comment_idx <- which(grepl("^#", first))
  if (length(comment_idx) == 0L) stop("No commented header line found in: ", path)
  header_line <- first[max(comment_idx)]
  header_line <- sub("^#\\s*", "", header_line)
  header_line <- sub("^\ufeff", "", header_line)
  header_vec  <- strsplit(header_line, "\t", fixed = TRUE)[[1]]
  header_vec  <- gsub('^"|"$', "", header_vec)
  dt <- data.table::fread(path, skip = length(comment_idx), header = FALSE, sep = "\t", quote = "")
  if (ncol(dt) != length(header_vec)) {
    stop(sprintf("Header columns (%d) != data columns (%d) in %s",
                 length(header_vec), ncol(dt), path))
  }
  data.table::setnames(dt, header_vec)
  dt
}

to_matrix <- function(dt) {
  rn <- dt[[1]]
  mat <- as.matrix(dt[, -1, with = FALSE])
  rownames(mat) <- rn
  storage.mode(mat) <- "numeric"
  mat[is.na(mat)] <- 0
  mat
}

sanitize_matrix <- function(mat) {
  mat <- as.matrix(mat)
  storage.mode(mat) <- "numeric"
  mat[!is.finite(mat)] <- 0
  mat
}

dt_mgx <- read_ibdmdb_tsv(f_mgx)
dt_mtx <- read_ibdmdb_tsv(f_mtx)
mat_mgx <- to_matrix(dt_mgx)
mat_mtx <- to_matrix(dt_mtx)

#harmonize samples
shared <- intersect(colnames(mat_mgx), colnames(mat_mtx))
shared <- sort(unique(shared[nchar(shared) > 0]))
stopifnot(length(shared) >= 20)
X_mgx <- mat_mgx[, shared, drop = FALSE]
X_mtx <- mat_mtx[, shared, drop = FALSE]

#filter features/samples
n_samp <- length(shared)
keep_mgx <- rowSums(X_mgx > 0) >= ceiling(0.05 * n_samp)
keep_mtx <- rowSums(X_mtx > 0) >= ceiling(0.02 * n_samp)
X_mgx <- X_mgx[keep_mgx, , drop = FALSE]
X_mtx <- X_mtx[keep_mtx, , drop = FALSE]

keep_samp_mgx <- colSums(X_mgx) > 0
keep_samp_mtx <- colSums(X_mtx) > 0
X_mgx <- X_mgx[, keep_samp_mgx, drop = FALSE]
X_mtx <- X_mtx[, keep_samp_mtx, drop = FALSE]

shared_final <- sort(intersect(colnames(X_mgx), colnames(X_mtx)))
stopifnot(length(shared_final) >= 20)
X_mgx <- X_mgx[, shared_final, drop = FALSE]
X_mtx <- X_mtx[, shared_final, drop = FALSE]

#cap MTX features for speed
max_mtx_features <- 10000
if (nrow(X_mtx) > max_mtx_features) {
  ord <- order(matrixStats::rowVars(X_mtx), decreasing = TRUE)
  X_mtx <- X_mtx[ord[seq_len(max_mtx_features)], , drop = FALSE]
}

#clean
X_mgx <- sanitize_matrix(dedup_rownames(X_mgx))
X_mtx <- sanitize_matrix(dedup_rownames(X_mtx))

cat("Final dims — MGX:", nrow(X_mgx), "x", ncol(X_mgx),
    "| MTX:", nrow(X_mtx), "x", ncol(X_mtx), "\n")

#build SEs and MAEs
cd <- S4Vectors::DataFrame(row.names = colnames(X_mgx))
se_mgx <- SummarizedExperiment::SummarizedExperiment(list(counts = X_mgx), colData = cd)
se_mtx <- SummarizedExperiment::SummarizedExperiment(list(counts = X_mtx), colData = cd)

mae_joint <- MultiAssayExperiment::MultiAssayExperiment(list(MGX = se_mgx, MTX = se_mtx))
mae_joint <- MultiAssayExperiment::intersectColumns(mae_joint)

#single-omic MAEs
mae_mgx <- MultiAssayExperiment::MultiAssayExperiment(list(MGX = se_mgx))
mae_mtx <- MultiAssayExperiment::MultiAssayExperiment(list(MTX = se_mtx))

#build groups (IBD vs non-IBD) from metadata
meta_df <- if (file.exists(f_meta)) data.frame(data.table::fread(f_meta)) else NULL
grp_df  <- make_groups_autodetect(meta_df, colnames(X_mgx))
table(grp_df$Group, useNA = "ifany")

# ------------------------------------------------------------------------------
#joint vs single-omic comparison
# ------------------------------------------------------------------------------

#choose a safe k
per_view_min_dim <- sapply(list(X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k0 <- min(3L, k_max)

#run fits
res_joint <- .fit_and_score(mae_joint, k0, grp_df)
res_mgx   <- .fit_and_score(mae_mgx,   k0, grp_df)
res_mtx   <- .fit_and_score(mae_mtx,   k0, grp_df)

bench_tbl <- rbind(
    cbind(model = "Joint (MGX+MTX)", t(.grab(res_joint))),
    cbind(model = "MGX only",         t(.grab(res_mgx))),
    cbind(model = "MTX only",         t(.grab(res_mtx)))
) %>% as.data.frame()

bench_tbl[, -1] <- lapply(bench_tbl[, -1, drop = FALSE], function(z) as.numeric(z))
knitr::kable(bench_tbl, digits = 3)

# ------------------------------------------------------------------------------
#plots: Ordinations (PC1 vs PC2)
# ------------------------------------------------------------------------------

print(.plt_ord(res_joint$scores, sprintf("Joint-RPCA (k=%d)", k0)))
print(.plt_ord(res_mgx$scores,   sprintf("MGX only (k=%d)", k0)))
print(.plt_ord(res_mtx$scores,   sprintf("MTX only (k=%d)", k0)))

# ------------------------------------------------------------------------------
#sensitivity to rank k
# ------------------------------------------------------------------------------

ks <- sort(unique(pmax(1, pmin(c(2, 3, 4, 5), k_max))))
sens <- lapply(ks, function(k) {
    rj <- .fit_and_score(mae_joint, k, grp_df)$metrics
    rm <- .fit_and_score(mae_mgx,   k, grp_df)$metrics
    rt <- .fit_and_score(mae_mtx,   k, grp_df)$metrics
    
    num_or_na <- function(x) if (is.null(x)) NA_real_ else as.numeric(x)
    
    data.frame(
        k = rep(k, 3),
        model = c("Joint", "MGX", "MTX"),
        AUROC = c(
            num_or_na(rj$AUROC),
            num_or_na(rm$AUROC),
            num_or_na(rt$AUROC)
        ),
        permanova_R2 = c(
            num_or_na(rj$permanova_R2),
            num_or_na(rm$permanova_R2),
            num_or_na(rt$permanova_R2)
        ),
        wilcox_PC1_p = c(
            num_or_na(rj$wilcox_PC1_p),
            num_or_na(rm$wilcox_PC1_p),
            num_or_na(rt$wilcox_PC1_p)
        ),
        stringsAsFactors = FALSE
    )
})
sens_df <- do.call(rbind, sens)
knitr::kable(sens_df, digits = 3)

ggplot2::ggplot(sens_df, ggplot2::aes(k, AUROC, group = model, color = model)) +
    ggplot2::geom_line() + ggplot2::geom_point() +
    ggplot2::scale_x_continuous(breaks = ks) +
    ggplot2::labs(title = "AUROC vs rank k", x = "k", y = "AUROC") +
    ggplot2::theme_minimal()

ggplot2::ggplot(sens_df, ggplot2::aes(k, permanova_R2, group = model, color = model)) +
    ggplot2::geom_line() + ggplot2::geom_point() +
    ggplot2::scale_x_continuous(breaks = ks) +
    ggplot2::labs(title = "PERMANOVA R² vs rank k", x = "k", y = "R²") +
    ggplot2::theme_minimal()

# ------------------------------------------------------------------------------
#stability: subject-wise train/test split
# ------------------------------------------------------------------------------

set.seed(123)
samps <- colnames(X_mgx)

ss_map <- .build_sample_subject_map(meta_df, samps)

if (!is.null(ss_map)) {
    dfidx <- data.frame(sample_id = tolower(samps), stringsAsFactors = FALSE)
    ss_map$sample_id <- tolower(ss_map$sample_id)
    dfidx <- dplyr::left_join(dfidx, ss_map, by = "sample_id")
    dfidx$subject_id[is.na(dfidx$subject_id)] <- paste0("unk_", seq_len(sum(is.na(dfidx$subject_id))))
    
    subjects <- unique(dfidx$subject_id)
    tr_subj <- sample(subjects, size = floor(0.7 * length(subjects)))
    idx_train <- which(dfidx$subject_id %in% tr_subj)
    idx_test  <- setdiff(seq_len(ncol(X_mgx)), idx_train)
    message(sprintf("[CV] Using subject-wise split: train subjects=%d, test subjects=%d",
                    length(tr_subj), length(subjects) - length(tr_subj)))
} else {
    n <- ncol(X_mgx)
    idx_train <- sample(seq_len(n), size = floor(0.7 * n))
    idx_test  <- setdiff(seq_len(n), idx_train)
    message("[CV] Subject column not found — falling back to sample-wise split.")
}

mae_train <- .make_mae_for(idx_train)
mae_test  <- .make_mae_for(idx_test)

mae_train <- runJointRPCA(
    x = mae_train,
    n.components = k0,
    max.iterations = 5,
    rclr.transform.tables = TRUE,
    min.sample.count = 1,
    min.feature.count = 0,
    min.feature.frequency = 0
)
fit_tr <- metadata(mae_train)$JointRPCA[["JointRPCA"]]

mae_test <- runJointRPCA(
    x = mae_test,
    n.components = k0,
    max.iterations = 5,
    rclr.transform.tables = TRUE,
    min.sample.count = 1,
    min.feature.count = 0,
    min.feature.frequency = 0
)
fit_te <- metadata(mae_test)$JointRPCA[["JointRPCA"]]

pc1_tr <- fit_tr$ord.res$samples[, 1]
pc1_te <- fit_te$ord.res$samples[, 1]
cat("PC1 stability (subject-wise train/test): variance on each split.\n")
c(var_train = var(pc1_tr), var_test = var(pc1_te))

# ------------------------------------------------------------------------------
#standard PCA / NMF
# ------------------------------------------------------------------------------

#shared CLR inputs (MGX / MTX as features x samples)
MGX_clr <- .clr_transform(X_mgx)
MTX_clr <- .clr_transform(X_mtx)
sample_ids <- colnames(MGX_clr)

#PCA on concatenated MGX+MTX (after CLR)
X_concat <- rbind(.zscore_rows(MGX_clr), .zscore_rows(MTX_clr))
X_concat_t <- t(X_concat)
pc_fit <- try(prcomp(X_concat_t, center = TRUE, scale. = FALSE), silent = TRUE)

cmp_pca <- NULL
if (!inherits(pc_fit, "try-error")) {
    pcs <- pc_fit$x[, seq_len(min(k0, ncol(pc_fit$x))), drop = FALSE]
    pca_scores <- .make_scores_df(pcs, rownames(pc_fit$x))
    cmp_pca <- .eval_wrapper(pca_scores, sprintf("PCA (concat CLR, k=%d)", min(k0, ncol(pcs))))
} else {
    message("[PCA] skipped: ", as.character(pc_fit))
}

#NMF (Hellinger)
cmp_nmf <- NULL

MGX_h <- .hellinger(X_mgx)
MTX_h <- .hellinger(X_mtx)
V_h   <- rbind(MGX_h, MTX_h)
stopifnot(ncol(V_h) == length(sample_ids))

set.seed(42)
nmf_k <- k0
if (requireNamespace("NMF", quietly = TRUE)) {
    nmf_fit <- try(
        NMF::nmf(V_h, rank = nmf_k, method = "brunet", nrun = 5, .options = "t"),
        silent = TRUE
    )
    if (!inherits(nmf_fit, "try-error")) {
        H <- NMF::coef(nmf_fit)
        S <- t(H)[, seq_len(min(nmf_k, nrow(t(H)))), drop = FALSE]
        nmf_scores <- .make_scores_df(S, sample_ids)
        cmp_nmf <- .eval_wrapper(nmf_scores, sprintf("NMF (Hellinger, k=%d)", ncol(S)))
    } else {
        message("[NMF] NMF::nmf failed: ", as.character(nmf_fit))
    }
} else if (requireNamespace("NNLM", quietly = TRUE)) {
    nn <- try(
        NNLM::nnmf(V_h, k = nmf_k, loss = "mse", max.iter = 1000, rel.tol = 1e-4),
        silent = TRUE
    )
    if (!inherits(nn, "try-error")) {
        H <- nn$H
        S <- t(H)[, seq_len(min(nmf_k, nrow(t(H)))), drop = FALSE]
        nmf_scores <- .make_scores_df(S, sample_ids)
        cmp_nmf <- .eval_wrapper(nmf_scores, sprintf("NMF (Hellinger, k=%d, NNLM)", ncol(S)))
    } else {
        message("[NMF] NNLM::nnmf failed: ", as.character(nn))
    }
} else {
    message("[NMF] skipped: install NMF or NNLM.")
}

# ------------------------------------------------------------------------------
#collect & display comparator metrics
# ------------------------------------------------------------------------------

comparators <- Filter(Negate(is.null),
                      list(cmp_pca = cmp_pca,
                           cmp_nmf = cmp_nmf)
)

if (length(comparators)) {
    comp_tbl <- do.call(rbind, lapply(comparators, function(x) {
        m <- x$metrics
        num_or_na <- function(z) if (is.null(z)) NA_real_ else as.numeric(z)
        data.frame(
            model        = x$model,
            wilcox_PC1_p = num_or_na(m$wilcox_PC1_p),
            wilcox_PC2_p = num_or_na(m$wilcox_PC2_p),
            permanova_R2 = num_or_na(m$permanova_R2),
            permanova_p  = num_or_na(m$permanova_p),
            AUROC        = num_or_na(m$AUROC),
            stringsAsFactors = FALSE
        )
    }))
    knitr::kable(comp_tbl, digits = 3, caption = "Comparators: PCA / NMF")
    
    invisible(lapply(comparators, function(x) print(.plot_comp(x))))
} else {
    message("No comparator results available (all skipped).")
}

# ------------------------------------------------------------------------------
#comparison bars: Joint-RPCA vs PCA vs NMF
# ------------------------------------------------------------------------------

joint_row <- bench_tbl %>%
    dplyr::filter(grepl("^Joint", model)) %>%
    dplyr::mutate(model_simple = "Joint-RPCA")

comp_rows <- if (exists("comp_tbl")) {
    comp_tbl %>%
        dplyr::mutate(
            model_simple = dplyr::case_when(
                grepl("^PCA", model) ~ "PCA",
                grepl("^NMF", model) ~ "NMF",
                TRUE ~ model
            )
        )
} else {
    data.frame()
}

cmp_all <- dplyr::bind_rows(
    joint_row %>% dplyr::select(model_simple, permanova_R2, AUROC),
    comp_rows %>% dplyr::select(model_simple, permanova_R2, AUROC)
) %>%
    dplyr::distinct() %>%
    dplyr::filter(model_simple %in% c("Joint-RPCA", "PCA", "NMF")) %>%
    dplyr::mutate(
        model_simple = factor(model_simple, levels = c("Joint-RPCA", "PCA", "NMF"))
    )

cmp_long <- tidyr::pivot_longer(
    cmp_all,
    cols = c(permanova_R2, AUROC),
    names_to = "metric",
    values_to = "value"
) %>%
    dplyr::filter(!is.na(value))

ggplot2::ggplot(cmp_long, ggplot2::aes(x = model_simple, y = value, fill = metric)) +
    ggplot2::geom_col(position = ggplot2::position_dodge(width = 0.7), width = 0.6) +
    ggplot2::geom_text(
        ggplot2::aes(label = sprintf("%.3f", value)),
        position = ggplot2::position_dodge(width = 0.7),
        vjust = -0.35, size = 3
    ) +
    ggplot2::geom_hline(
        data = subset(cmp_long, metric == "AUROC"),
        ggplot2::aes(yintercept = 0.5),
        linetype = 2, linewidth = 0.3, inherit.aes = FALSE
    ) +
    ggplot2::coord_cartesian(
        ylim = c(0, max(1, max(cmp_long$value, na.rm = TRUE) * 1.1))
    ) +
    ggplot2::labs(
        title = "Joint-RPCA vs PCA vs NMF",
        subtitle = "Side-by-side comparison of PERMANOVA R² and AUROC",
        x = NULL, y = "Score", fill = NULL
    ) +
    ggplot2::theme_minimal(base_size = 11) +
    ggplot2::theme(legend.position = "top")

```
