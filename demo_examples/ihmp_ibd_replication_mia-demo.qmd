---
title: "Joint RPCA — iHMP IBD Mini-Replication"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

	
# Install merged branch containing Joint-RPCA
remotes::install_github("microbiome/mia", ref = "rpca", upgrade = "never")

#necessary imports
library(Matrix)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vegan)
library(MultiAssayExperiment)
library(pROC)
library(mia)
library(HMP2Data)
library(ranger)
library(NMF)

# -------------------------------------------------------------------
#load IBD 16S from HMP2Data and convert via mia
# -------------------------------------------------------------------

IBD <- IBD16S()   #phyloseq with otu_table, sample_data, tax_table
IBD

#use mia helper instead of manual phyloseq → matrix wrangling
tse <- mia::convertFromPhyloseq(IBD)

#convenience objects (all aligned with tse)
otu  <- as.matrix(assay(tse, "counts"))
tax  <- as.data.frame(rowData(tse))
meta <- as.data.frame(colData(tse))

# -------------------------------------------------------------------
#grouping: IBD vs non-IBD
# -------------------------------------------------------------------

label_col <- "diagnosis"
stopifnot(label_col %in% colnames(meta))

meta$Group <- dplyr::case_when(
    meta[[label_col]] %in% c("UC", "CD")                           ~ "IBD",
    grepl("^non", meta[[label_col]], ignore.case = TRUE)           ~ "non-IBD",
    TRUE                                                           ~ NA_character_
)
meta$Group <- factor(meta$Group, levels = c("IBD", "non-IBD"))

#drop samples with NA group, and subset tse/otu/tax/meta in sync
keep_labeled <- !is.na(meta$Group)
tse  <- tse[, keep_labeled]
otu  <- otu[, keep_labeled, drop = FALSE]
meta <- meta[keep_labeled, , drop = FALSE]

#keep Group in colData(tse) as well 
colData(tse)$Group <- meta$Group

# -------------------------------------------------------------------
#rCLR transform and Joint-RPCA via runJointRPCA
# -------------------------------------------------------------------

se <- tse  #single 16S experiment as a TreeSummarizedExperiment/SummarizedExperiment

mae <- MultiAssayExperiment::MultiAssayExperiment(
    experiments = list(view_16S = se)
)

head(colnames(se))
head(rownames(mia:::jointRPCAuniversal(x = mae, transform="rclr", n.components=2, max.iterations=2)$ord_res$samples))

```
