---
title: "IBDMDB — 2-Omic Joint-RPCA (MGX + MTX)"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

# Install merged branch containing Joint-RPCA
remotes::install_github("microbiome/mia", ref = "rpca", upgrade = "never")

#necessary imports
library(dplyr)
library(tidyr)
library(ggplot2)
library(mia)

# Helpers

.get_view <- function(obj, keys) {
  if (is.null(obj)) return(NULL)
  if (is.list(obj)) {
    for (k in keys) if (!is.null(obj[[k]])) return(as.data.frame(obj[[k]]))
    return(NULL)
  }
  #fallback: if it's a matrix/data.frame but not split by view, skip splitting
  if (is.matrix(obj) || is.data.frame(obj)) return(as.data.frame(obj))
  return(NULL)
}

.show_top <- function(V, label, top_k = 15) {
  if (is.null(V) || !ncol(V)) return(NULL)
  ord <- order(V[, 1], decreasing = TRUE)
  top_ix <- seq_len(min(top_k, length(ord)))
  data.frame(
    label = label,
    feature = rownames(V)[ord][top_ix],
    loading = V[ord, 1][top_ix],
    row.names = NULL,
    stringsAsFactors = FALSE
  )
}

# --------------------------------------------------------------------
#load packaged demo data
# --------------------------------------------------------------------

data(ibdmdb_2omic_demo)

# MultiAssayExperiment with MGX + MTX
mae_2 <- ibdmdb_2omic_demo

#extract assays (features x samples)
se_mgx <- mae_2[["MGX"]]
se_mtx <- mae_2[["MTX"]]

X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)

stopifnot(identical(colnames(X_mgx), colnames(X_mtx)))
sample_ids <- colnames(X_mgx)

# --------------------------------------------------------------------
#choose a safe rank k and run Joint-RPCA
# --------------------------------------------------------------------

per_view_min_dim <- sapply(list(X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k     <- min(3L, k_max)

message(sprintf(
    "[2-omic] per-view min dims = %s; using k = %d",
    paste(per_view_min_dim, collapse = ", "), k
))

# make sure both experiments have an assay called "counts" 
se_mgx <- mae_2[["MGX"]]
se_mtx <- mae_2[["MTX"]]

SummarizedExperiment::assay(se_mgx, "counts") <- SummarizedExperiment::assay(se_mgx, 1L)
SummarizedExperiment::assay(se_mtx, "counts") <- SummarizedExperiment::assay(se_mtx, 1L)

mae_2[["MGX"]] <- se_mgx
mae_2[["MTX"]] <- se_mtx

# call jointRPCAuniversal
args <- list(
  x = mae_2,
  transform = "rclr",
  n.components = k,
  max.iterations = 5,
  min.sample.count = 0,
  min.feature.count = 0,
  min.feature.frequency = 0
)

args <- args[names(args) %in% names(formals(mia:::jointRPCAuniversal))]
fit2 <- do.call(mia:::jointRPCAuniversal, args)

metadata(mae_2)$JointRPCA <- list(JointRPCA = fit2)

# --------------------------------------------------------------------
#scores and loadings
# --------------------------------------------------------------------

U <- as.data.frame(fit2$ord_res$samples)
colnames(U) <- paste0("V", seq_len(ncol(U)))
U$sample_id <- trimws(rownames(U))

V_mgx <- .get_view(fit2$ord_res$features, c("MGX", "view_MGX", "view_mgx"))
V_mtx <- .get_view(fit2$ord_res$features, c("MTX", "view_MTX", "view_mtx"))

# --------------------------------------------------------------------
#attach IBD/non-IBD groups and plot ordination
# --------------------------------------------------------------------

meta_df <- as.data.frame(SummarizedExperiment::colData(mae_2), stringsAsFactors = FALSE)
meta_df$sample_id <- rownames(meta_df)

meta_df$diagnosis <- as.character(meta_df$diagnosis)
meta_df$Group <- dplyr::case_when(
  meta_df$diagnosis %in% c("UC", "CD") ~ "IBD",
  grepl("^non", meta_df$diagnosis, ignore.case = TRUE) ~ "non-IBD",
  TRUE ~ NA_character_
)
meta_df$Group <- factor(meta_df$Group, levels = c("IBD", "non-IBD"))

grp_df <- meta_df[, c("sample_id", "Group")]
grp_df$sample_id <- as.character(grp_df$sample_id)

print(sort(table(grp_df$Group, useNA = "ifany")))

U2 <- dplyr::left_join(U, grp_df, by = "sample_id")
U2_plot <- dplyr::filter(U2, !is.na(Group))
tab <- table(U2$Group, useNA = "ifany")
print(tab)

#PC1–PC2 colored by Group
ggplot(U2_plot, aes(x = V1, y = V2, color = Group)) +
    geom_point(alpha = 0.85, size = 1.2) +
    labs(
        title = sprintf("Joint-RPCA (MGX + MTX), k = %d — PC1 vs PC2", k),
        x = "PC1", y = "PC2", color = NULL
    ) +
    theme_minimal()

# --------------------------------------------------------------------
#quick top-loadings on PC1 for each view
# --------------------------------------------------------------------

.show_top(V_mgx, "MGX")
.show_top(V_mtx, "MTX")



```
