---
title: "IBDMDB â€” 2-Omic Joint-RPCA (MGX + MTX)"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

# Install merged branch containing Joint-RPCA
remotes::install_github("microbiome/mia", ref = "rpca", upgrade = "never")

#necessary imports
library(dplyr)
library(tidyr)
library(ggplot2)
library(mia)

# Helpers

.get_view <- function(obj, keys) {
  if (is.null(obj)) return(NULL)
  if (is.list(obj)) {
    for (k in keys) if (!is.null(obj[[k]])) return(as.data.frame(obj[[k]]))
    return(NULL)
  }
  #fallback: if it's a matrix/data.frame but not split by view, skip splitting
  if (is.matrix(obj) || is.data.frame(obj)) return(as.data.frame(obj))
  return(NULL)
}

.make_groups_autodetect <- function(meta_df, sample_ids, min_frac = 0.01, min_abs = 10L) {
  #always return a data.frame(sample_id, Group)
  out <- data.frame(sample_id = sample_ids, Group = factor(NA, levels = c("IBD", "non-IBD")),
                    stringsAsFactors = FALSE)
  if (is.null(meta_df) || !nrow(meta_df)) return(out)

  md <- as.data.frame(meta_df, stringsAsFactors = FALSE)
  names(md) <- tolower(trimws(names(md)))

  sid <- tolower(trimws(as.character(sample_ids)))
  thresh <- max(min_abs, floor(length(sid) * min_frac))

  #overlap of every column with our sample IDs
  overlaps <- sapply(md, function(col) {
    x <- tolower(trimws(as.character(col)))
    sum(!is.na(x) & x %in% sid)
  })

  #choose the best column, but only if it clears the threshold
  max_ov <- suppressWarnings(max(overlaps, na.rm = TRUE))
  if (!is.finite(max_ov) || max_ov < thresh) {
    message(sprintf("[meta] No metadata column matches sample IDs (max overlap = %s < %d). Group left NA.",
                    as.character(max_ov), thresh))
    return(out)
  }
  best <- names(overlaps)[which.max(overlaps)]
  message(sprintf("[meta] Chosen sample-id column: '%s' (matches = %d)", best, overlaps[[best]]))

  if (!"diagnosis" %in% names(md)) {
    message("[meta] 'diagnosis' not found; Group left NA.")
    return(out)
  }

  #build IBD / non-IBD from diagnosis
  dx  <- tolower(trimws(as.character(md$diagnosis)))
  grp <- ifelse(grepl("\\b(uc|cd|ibd)\\b", dx), "IBD",
         ifelse(grepl("^\\s*non", dx), "non-IBD", NA_character_))

  md$sample_id <- tolower(trimws(as.character(md[[best]])))
  md$Group <- factor(grp, levels = c("IBD", "non-IBD"))

  join_tbl <- unique(md[, c("sample_id", "Group")])
  out <- dplyr::left_join(
    data.frame(sample_id = sid, stringsAsFactors = FALSE),
    join_tbl,
    by = "sample_id"
  )
  out$sample_id <- sample_ids  #restore original casing
  out
}

.show_top <- function(V, label, top_k = 15) {
  if (is.null(V) || !ncol(V)) return(NULL)
  ord <- order(V[, 1], decreasing = TRUE)
  top_ix <- seq_len(min(top_k, length(ord)))
  data.frame(
    label = label,
    feature = rownames(V)[ord][top_ix],
    loading = V[ord, 1][top_ix],
    row.names = NULL,
    stringsAsFactors = FALSE
  )
}

# --------------------------------------------------------------------
#load packaged demo data
# --------------------------------------------------------------------

data(ibdmdb_2omic_demo)

# MultiAssayExperiment with MGX + MTX
mae_2 <- ibdmdb_2omic_demo

#extract assays (features x samples)
se_mgx <- mae_2[["MGX"]]
se_mtx <- mae_2[["MTX"]]

X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)

stopifnot(identical(colnames(X_mgx), colnames(X_mtx)))
sample_ids <- colnames(X_mgx)

# --------------------------------------------------------------------
#choose a safe rank k and run Joint-RPCA
# --------------------------------------------------------------------

per_view_min_dim <- sapply(list(X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k     <- min(3L, k_max)

message(sprintf(
    "[2-omic] per-view min dims = %s; using k = %d",
    paste(per_view_min_dim, collapse = ", "), k
))

# make sure both experiments have an assay called "counts" 
se_mgx <- mae_2[["MGX"]]
se_mtx <- mae_2[["MTX"]]

SummarizedExperiment::assay(se_mgx, "counts") <- SummarizedExperiment::assay(se_mgx, 1L)
SummarizedExperiment::assay(se_mtx, "counts") <- SummarizedExperiment::assay(se_mtx, 1L)

mae_2[["MGX"]] <- se_mgx
mae_2[["MTX"]] <- se_mtx



```
