---
title: "IBDMDB — 3-Omic Joint-RPCA (MGX + MTX + 16S)"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

#necessary imports
library(dplyr)
library(tidyr)
library(ggplot2)
library(mia)

#load packaged demo data
data(ibdmdb_3omic_demo)
suppressWarnings(data(ibdmdb_meta_demo))

#use the MultiAssayExperiment directly
mae_3 <- mae3

#extract per-view assays (features x samples)
se_16s <- mae_3[["16S"]]
se_mgx <- mae_3[["MGX"]]
se_mtx <- mae_3[["MTX"]]

X_16s <- SummarizedExperiment::assay(se_16s, 1L)
X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)

#sample IDs used later
sample_ids <- colnames(X_mgx)

# ------------------------------------------------------------------------------
#minimal helpers
# ------------------------------------------------------------------------------

make_groups_autodetect <- function(meta_df, sample_ids, min_frac = 0.01, min_abs = 10L) {
  out <- data.frame(
    sample_id = sample_ids,
    Group = factor(NA, levels = c("IBD", "non-IBD"))
  )
  if (is.null(meta_df) || !nrow(meta_df)) return(out)

  md <- as.data.frame(meta_df, stringsAsFactors = FALSE)
  names(md) <- tolower(trimws(names(md)))

  sid <- tolower(trimws(sample_ids))
  overlaps <- sapply(md, function(col) {
    x <- tolower(trimws(as.character(col)))
    sum(!is.na(x) & x %in% sid)
  })

  thresh  <- max(min_abs, floor(length(sid) * min_frac))
  max_ov  <- suppressWarnings(max(overlaps, na.rm = TRUE))
  if (!is.finite(max_ov) || max_ov < thresh || !"diagnosis" %in% names(md)) return(out)

  best <- names(overlaps)[which.max(overlaps)]

  dx  <- tolower(trimws(as.character(md$diagnosis)))
  grp <- ifelse(grepl("\\b(uc|cd|ibd)\\b", dx), "IBD",
         ifelse(grepl("^\\s*non", dx), "non-IBD", NA_character_))

  md$sample_id <- tolower(trimws(as.character(md[[best]])))
  md$Group     <- factor(grp, levels = c("IBD", "non-IBD"))
  join_tbl     <- unique(md[, c("sample_id", "Group")])

  j <- dplyr::left_join(
    data.frame(sample_id = sid),
    join_tbl, by = "sample_id"
  )
  j$sample_id <- sample_ids
  j
}

get_view <- function(obj, keys) {
  if (is.null(obj)) return(NULL)
  if (is.list(obj)) {
    for (k in keys) {
      if (!is.null(obj[[k]])) return(as.data.frame(obj[[k]]))
    }
    return(NULL)
  }
  if (is.matrix(obj) || is.data.frame(obj)) return(as.data.frame(obj))
  NULL
}

show_top <- function(V, label, top_k = 15) {
  if (is.null(V) || !ncol(V)) return(invisible(NULL))
  ord   <- order(V[, 1], decreasing = TRUE)
  top_ix <- seq_len(min(top_k, length(ord)))
  cat(sprintf("\nTop %s features on PC1:\n", label))
  print(data.frame(
    feature = rownames(V)[ord][top_ix],
    loading = V[ord, 1][top_ix]
  ))
}

# ------------------------------------------------------------------------------
#choose rank k safely and run Joint-RPCA
# ------------------------------------------------------------------------------

per_view_min_dim <- sapply(list(X_16s, X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k     <- min(3L, k_max)

message(sprintf(
  "[3-omic] per-view min dims = %s; using k = %d",
  paste(per_view_min_dim, collapse = ", "), k
))

set.seed(42)
mae_3 <- runJointRPCA(
  x                    = mae_3,
  n.components         = k,
  max.iterations       = 5,
  rclr.transform.tables = TRUE,
  min.sample.count     = 1,
  min.feature.count    = 0,
  min.feature.frequency = 0
)

#retrieve full Joint-RPCA result
fit3 <- metadata(mae_3)$JointRPCA[["JointRPCA"]]

#joint scores for samples
U <- as.data.frame(fit3$ord.res$samples)
colnames(U) <- paste0("V", seq_len(ncol(U)))
U$sample_id <- rownames(U)

#feature loadings per view (if available)
V_16S <- get_view(fit3$ord.res$features, c("16S", "view_16S", "view_16s"))
V_MGX <- get_view(fit3$ord.res$features, c("MGX", "view_MGX", "view_mgx"))
V_MTX <- get_view(fit3$ord.res$features, c("MTX", "view_MTX", "view_mtx"))

# ------------------------------------------------------------------------------
#attach IBD / non-IBD groups from metadata and plot ordination
# ------------------------------------------------------------------------------

meta_df <- if (exists("ibdmdb_meta_demo")) ibdmdb_meta_demo else NULL
grp_df  <- make_groups_autodetect(meta_df, U$sample_id)

print(sort(table(grp_df$Group, useNA = "ifany")))

U2 <- dplyr::left_join(U, grp_df, by = "sample_id")
tab <- table(U2$Group, useNA = "ifany")
print(tab)

#colored PC1–PC2 ordination
ggplot(U2, aes(x = V1, y = V2, color = Group)) +
  geom_point(alpha = 0.85, size = 1.2) +
  labs(
    title = sprintf("Joint-RPCA (16S + MGX + MTX), k = %d — PC1 vs PC2", k),
    x = "PC1", y = "PC2", color = NULL
  ) +
  theme_minimal()

# ------------------------------------------------------------------------------
#top PC1 loadings per view
# ------------------------------------------------------------------------------

show_top(V_16S, "16S")
show_top(V_MGX, "MGX")
show_top(V_MTX, "MTX")

# ------------------------------------------------------------------------------
#variance explained (scree plot)
# ------------------------------------------------------------------------------

eigvals <- fit3$ord.res$eigvals
var_df <- data.frame(
  PC       = seq_along(eigvals),
  Variance = eigvals^2 / sum(eigvals^2)
)

ggplot(var_df, aes(x = PC, y = Variance)) +
  geom_col() +
  labs(
    title = "Variance explained per component",
    x = "Component", y = "Proportion of variance"
  ) +
  theme_minimal()

# ------------------------------------------------------------------------------
#component correlation heatmap (joint scores)
# ------------------------------------------------------------------------------

#use the first k components for correlation
comp_cols <- paste0("V", seq_len(min(k, ncol(U) - 1)))
corr <- cor(as.matrix(U[, comp_cols, drop = FALSE]), use = "pairwise.complete.obs")

corr_df <- as.data.frame(as.table(corr))
colnames(corr_df) <- c("Comp1", "Comp2", "Correlation")

ggplot(corr_df, aes(x = Comp1, y = Comp2, fill = Correlation)) +
  geom_tile() +
  scale_fill_gradient2() +
  coord_equal() +
  labs(
    title = "Component correlation matrix",
    x = NULL, y = NULL
  ) +
  theme_minimal()



```
