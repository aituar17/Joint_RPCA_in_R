---
title: "IBDMDB — 3-Omic Joint-RPCA (MGX + MTX + 16S)"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

#necessary imports
library(dplyr)
library(tidyr)
library(ggplot2)
library(mia)

#load packaged demo data
data(ibdmdb_3omic_demo)
suppressWarnings(data(ibdmdb_meta_demo))

#use the MultiAssayExperiment directly
mae_3 <- mae3

#extract per-view assays (features x samples)
se_16s <- mae_3[["16S"]]
se_mgx <- mae_3[["MGX"]]
se_mtx <- mae_3[["MTX"]]

X_16s <- SummarizedExperiment::assay(se_16s, 1L)
X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)

#sample IDs used later
sample_ids <- colnames(X_mgx)

# ------------------------------------------------------------------------------
#choose rank k safely and run Joint-RPCA
# ------------------------------------------------------------------------------

per_view_min_dim <- sapply(list(X_16s, X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k     <- min(3L, k_max)

message(sprintf(
    "[3-omic] per-view min dims = %s; using k = %d",
    paste(per_view_min_dim, collapse = ", "), k
))

set.seed(42)
mae_3 <- runJointRPCA(
    x                    = mae_3,
    n.components         = k,
    max.iterations       = 5,
    rclr.transform.tables = TRUE,
    min.sample.count     = 1,
    min.feature.count    = 0,
    min.feature.frequency = 0
)

#retrieve full Joint-RPCA result
fit3 <- metadata(mae_3)$JointRPCA[["JointRPCA"]]

#joint scores for samples
U <- as.data.frame(fit3$ord.res$samples)
colnames(U) <- paste0("V", seq_len(ncol(U)))
U$sample_id <- rownames(U)

#feature loadings per view (if available)
V_16S <- mia:::.get_view(fit3$ord.res$features, c("16S", "view_16S", "view_16s"))
V_MGX <- mia:::.get_view(fit3$ord.res$features, c("MGX", "view_MGX", "view_mgx"))
V_MTX <- mia:::.get_view(fit3$ord.res$features, c("MTX", "view_MTX", "view_mtx"))

# ------------------------------------------------------------------------------
#attach IBD / non-IBD groups from metadata and plot ordination
# ------------------------------------------------------------------------------

meta_df <- if (exists("ibdmdb_meta_demo")) ibdmdb_meta_demo else NULL
grp_df  <- mia:::.make_groups_autodetect(meta_df, U$sample_id)

print(sort(table(grp_df$Group, useNA = "ifany")))

U2 <- dplyr::left_join(U, grp_df, by = "sample_id")
tab <- table(U2$Group, useNA = "ifany")
print(tab)

#colored PC1–PC2 ordination
ggplot(U2, aes(x = V1, y = V2, color = Group)) +
    geom_point(alpha = 0.85, size = 1.2) +
    labs(
        title = sprintf("Joint-RPCA (16S + MGX + MTX), k = %d — PC1 vs PC2", k),
        x = "PC1", y = "PC2", color = NULL
    ) +
    theme_minimal()

# ------------------------------------------------------------------------------
#top PC1 loadings per view
# ------------------------------------------------------------------------------

mia:::.show_top(V_16S, "16S")
mia:::.show_top(V_MGX, "MGX")
mia:::.show_top(V_MTX, "MTX")

# ------------------------------------------------------------------------------
#variance explained (scree plot)
# ------------------------------------------------------------------------------

eigvals <- fit3$ord.res$eigvals
var_df <- data.frame(
    PC       = seq_along(eigvals),
    Variance = eigvals^2 / sum(eigvals^2)
)

ggplot(var_df, aes(x = PC, y = Variance)) +
    geom_col() +
    labs(
        title = "Variance explained per component",
        x = "Component", y = "Proportion of variance"
    ) +
    theme_minimal()

# ------------------------------------------------------------------------------
#component correlation heatmap (joint scores)
# ------------------------------------------------------------------------------

#use the first k components for correlation
comp_cols <- paste0("V", seq_len(min(k, ncol(U) - 1)))
corr <- cor(as.matrix(U[, comp_cols, drop = FALSE]), use = "pairwise.complete.obs")

corr_df <- as.data.frame(as.table(corr))
colnames(corr_df) <- c("Comp1", "Comp2", "Correlation")

ggplot(corr_df, aes(x = Comp1, y = Comp2, fill = Correlation)) +
    geom_tile() +
    scale_fill_gradient2() +
    coord_equal() +
    labs(
        title = "Component correlation matrix",
        x = NULL, y = NULL
    ) +
    theme_minimal()

cat("\nSession info:\n")
print(sessionInfo())

```
