---
title: "IBDMDB — Joint-RPCA Benchmarking"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

#necessary imports
library(Matrix)
library(tidyr)
library(ggplot2)
library(vegan)
library(MultiAssayExperiment)
library(pROC)
library(dplyr, warn.conflicts = FALSE)
library(mia)

#load compact demo data
data(ibdmdb_2omic_demo)
suppressWarnings(data(ibdmdb_meta_demo))

#use the MultiAssayExperiment directly
mae_joint <- mae2
se_mgx    <- mae_joint[["MGX"]]
se_mtx    <- mae_joint[["MTX"]]

#matrices for PCA/NMF comparators etc.
X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)
stopifnot(identical(colnames(X_mgx), colnames(X_mtx)))
sample_ids <- colnames(X_mgx)

#single-omic MAEs for the baseline comparisons
mae_mgx <- MultiAssayExperiment::MultiAssayExperiment(list(MGX = se_mgx))
mae_mtx <- MultiAssayExperiment::MultiAssayExperiment(list(MTX = se_mtx))

#metadata
meta_df <- if (exists("ibdmdb_meta_demo")) ibdmdb_meta_demo else NULL

# ------------------------------------------------------------------------------
#build groups (IBD vs non-IBD) from metadata
# ------------------------------------------------------------------------------

meta_df <- if (exists("ibdmdb_meta_demo")) ibdmdb_meta_demo else NULL
grp_df  <- mia:::.make_groups_autodetect(meta_df, colnames(X_mgx))
table(grp_df$Group, useNA = "ifany")

# ------------------------------------------------------------------------------
#joint vs single-omic comparison
# ------------------------------------------------------------------------------

#choose a safe k
per_view_min_dim <- sapply(list(X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k0 <- min(3L, k_max)

#run fits
res_joint <- mia:::.fit_and_score(mae_joint, k0, grp_df)
res_mgx   <- mia:::.fit_and_score(mae_mgx,   k0, grp_df)
res_mtx   <- mia:::.fit_and_score(mae_mtx,   k0, grp_df)

bench_tbl <- rbind(
    cbind(model = "Joint (MGX+MTX)", t(mia:::.grab(res_joint))),
    cbind(model = "MGX only",         t(mia:::.grab(res_mgx))),
    cbind(model = "MTX only",         t(mia:::.grab(res_mtx)))
) %>% as.data.frame()

bench_tbl[, -1] <- lapply(bench_tbl[, -1, drop = FALSE], function(z) as.numeric(z))
knitr::kable(bench_tbl, digits = 3)

# ------------------------------------------------------------------------------
#plots: Ordinations (PC1 vs PC2)
# ------------------------------------------------------------------------------

print(mia:::.plt_ord(res_joint$scores, sprintf("Joint-RPCA (k=%d)", k0)))
print(mia:::.plt_ord(res_mgx$scores,   sprintf("MGX only (k=%d)", k0)))
print(mia:::.plt_ord(res_mtx$scores,   sprintf("MTX only (k=%d)", k0)))

# ------------------------------------------------------------------------------
#sensitivity to rank k
# ------------------------------------------------------------------------------

ks <- sort(unique(pmax(1, pmin(c(2, 3, 4, 5), k_max))))
sens <- lapply(ks, function(k) {
    rj <- mia:::.fit_and_score(mae_joint, k, grp_df)$metrics
    rm <- mia:::.fit_and_score(mae_mgx,   k, grp_df)$metrics
    rt <- mia:::.fit_and_score(mae_mtx,   k, grp_df)$metrics
    
    num_or_na <- function(x) if (is.null(x)) NA_real_ else as.numeric(x)
    
    data.frame(
        k = rep(k, 3),
        model = c("Joint", "MGX", "MTX"),
        AUROC = c(
            num_or_na(rj$AUROC),
            num_or_na(rm$AUROC),
            num_or_na(rt$AUROC)
        ),
        permanova_R2 = c(
            num_or_na(rj$permanova_R2),
            num_or_na(rm$permanova_R2),
            num_or_na(rt$permanova_R2)
        ),
        wilcox_PC1_p = c(
            num_or_na(rj$wilcox_PC1_p),
            num_or_na(rm$wilcox_PC1_p),
            num_or_na(rt$wilcox_PC1_p)
        ),
        stringsAsFactors = FALSE
    )
})
sens_df <- do.call(rbind, sens)
knitr::kable(sens_df, digits = 3)

ggplot2::ggplot(sens_df, ggplot2::aes(k, AUROC, group = model, color = model)) +
    ggplot2::geom_line() + ggplot2::geom_point() +
    ggplot2::scale_x_continuous(breaks = ks) +
    ggplot2::labs(title = "AUROC vs rank k", x = "k", y = "AUROC") +
    ggplot2::theme_minimal()

ggplot2::ggplot(sens_df, ggplot2::aes(k, permanova_R2, group = model, color = model)) +
    ggplot2::geom_line() + ggplot2::geom_point() +
    ggplot2::scale_x_continuous(breaks = ks) +
    ggplot2::labs(title = "PERMANOVA R² vs rank k", x = "k", y = "R²") +
    ggplot2::theme_minimal()

# ------------------------------------------------------------------------------
#stability: subject-wise train/test split
# ------------------------------------------------------------------------------

set.seed(123)
samps <- colnames(X_mgx)

ss_map <- mia:::.build_sample_subject_map(meta_df, samps)

if (!is.null(ss_map)) {
    dfidx <- data.frame(sample_id = tolower(samps), stringsAsFactors = FALSE)
    ss_map$sample_id <- tolower(ss_map$sample_id)
    dfidx <- dplyr::left_join(dfidx, ss_map, by = "sample_id")
    dfidx$subject_id[is.na(dfidx$subject_id)] <- paste0("unk_", seq_len(sum(is.na(dfidx$subject_id))))
    
    subjects <- unique(dfidx$subject_id)
    tr_subj <- sample(subjects, size = floor(0.7 * length(subjects)))
    idx_train <- which(dfidx$subject_id %in% tr_subj)
    idx_test  <- setdiff(seq_len(ncol(X_mgx)), idx_train)
    message(sprintf("[CV] Using subject-wise split: train subjects=%d, test subjects=%d",
                    length(tr_subj), length(subjects) - length(tr_subj)))
} else {
    n <- ncol(X_mgx)
    idx_train <- sample(seq_len(n), size = floor(0.7 * n))
    idx_test  <- setdiff(seq_len(n), idx_train)
    message("[CV] Subject column not found — falling back to sample-wise split.")
}

mae_train <- mia:::.make_mae_for(idx_train)
mae_test  <- mia:::.make_mae_for(idx_test)

mae_train <- runJointRPCA(
    x = mae_train,
    n.components = k0,
    max.iterations = 5,
    rclr.transform.tables = TRUE,
    min.sample.count = 1,
    min.feature.count = 0,
    min.feature.frequency = 0
)
fit_tr <- metadata(mae_train)$JointRPCA[["JointRPCA"]]

mae_test <- runJointRPCA(
    x = mae_test,
    n.components = k0,
    max.iterations = 5,
    rclr.transform.tables = TRUE,
    min.sample.count = 1,
    min.feature.count = 0,
    min.feature.frequency = 0
)
fit_te <- metadata(mae_test)$JointRPCA[["JointRPCA"]]

pc1_tr <- fit_tr$ord.res$samples[, 1]
pc1_te <- fit_te$ord.res$samples[, 1]
cat("PC1 stability (subject-wise train/test): variance on each split.\n")
c(var_train = var(pc1_tr), var_test = var(pc1_te))

# ------------------------------------------------------------------------------
#standard PCA / NMF
# ------------------------------------------------------------------------------

#shared CLR inputs (MGX / MTX as features x samples)
MGX_clr <- mia:::.clr_transform(X_mgx)
MTX_clr <- mia:::.clr_transform(X_mtx)
sample_ids <- colnames(MGX_clr)

#PCA on concatenated MGX+MTX (after CLR)
X_concat <- rbind(mia:::.zscore_rows(MGX_clr), mia:::.zscore_rows(MTX_clr))
X_concat_t <- t(X_concat)
pc_fit <- try(prcomp(X_concat_t, center = TRUE, scale. = FALSE), silent = TRUE)

cmp_pca <- NULL
if (!inherits(pc_fit, "try-error")) {
    pcs <- pc_fit$x[, seq_len(min(k0, ncol(pc_fit$x))), drop = FALSE]
    pca_scores <- mia:::.make_scores_df(pcs, rownames(pc_fit$x))
    cmp_pca <- mia:::.eval_wrapper(pca_scores, sprintf("PCA (concat CLR, k=%d)", min(k0, ncol(pcs))))
} else {
    message("[PCA] skipped: ", as.character(pc_fit))
}

#NMF (Hellinger)
cmp_nmf <- NULL

MGX_h <- mia:::.hellinger(X_mgx)
MTX_h <- mia:::.hellinger(X_mtx)
V_h   <- rbind(MGX_h, MTX_h)
stopifnot(ncol(V_h) == length(sample_ids))

set.seed(42)
nmf_k <- k0
if (requireNamespace("NMF", quietly = TRUE)) {
    nmf_fit <- try(
        NMF::nmf(V_h, rank = nmf_k, method = "brunet", nrun = 5, .options = "t"),
        silent = TRUE
    )
    if (!inherits(nmf_fit, "try-error")) {
        H <- NMF::coef(nmf_fit)
        S <- t(H)[, seq_len(min(nmf_k, nrow(t(H)))), drop = FALSE]
        nmf_scores <- mia:::.make_scores_df(S, sample_ids)
        cmp_nmf <- mia:::.eval_wrapper(nmf_scores, sprintf("NMF (Hellinger, k=%d)", ncol(S)))
    } else {
        message("[NMF] NMF::nmf failed: ", as.character(nmf_fit))
    }
} else if (requireNamespace("NNLM", quietly = TRUE)) {
    nn <- try(
        NNLM::nnmf(V_h, k = nmf_k, loss = "mse", max.iter = 1000, rel.tol = 1e-4),
        silent = TRUE
    )
    if (!inherits(nn, "try-error")) {
        H <- nn$H
        S <- t(H)[, seq_len(min(nmf_k, nrow(t(H)))), drop = FALSE]
        nmf_scores <- mia:::.make_scores_df(S, sample_ids)
        cmp_nmf <- mia:::.eval_wrapper(nmf_scores, sprintf("NMF (Hellinger, k=%d, NNLM)", ncol(S)))
    } else {
        message("[NMF] NNLM::nnmf failed: ", as.character(nn))
    }
} else {
    message("[NMF] skipped: install NMF or NNLM.")
}

# ------------------------------------------------------------------------------
#collect & display comparator metrics
# ------------------------------------------------------------------------------

comparators <- Filter(Negate(is.null),
                      list(cmp_pca = cmp_pca,
                           cmp_nmf = cmp_nmf)
)

if (length(comparators)) {
    comp_tbl <- do.call(rbind, lapply(comparators, function(x) {
        m <- x$metrics
        num_or_na <- function(z) if (is.null(z)) NA_real_ else as.numeric(z)
        data.frame(
            model        = x$model,
            wilcox_PC1_p = num_or_na(m$wilcox_PC1_p),
            wilcox_PC2_p = num_or_na(m$wilcox_PC2_p),
            permanova_R2 = num_or_na(m$permanova_R2),
            permanova_p  = num_or_na(m$permanova_p),
            AUROC        = num_or_na(m$AUROC),
            stringsAsFactors = FALSE
        )
    }))
    knitr::kable(comp_tbl, digits = 3, caption = "Comparators: PCA / NMF")
    
    invisible(lapply(comparators, function(x) print(mia:::.plot_comp(x))))
} else {
    message("No comparator results available (all skipped).")
}

# ------------------------------------------------------------------------------
#comparison bars: Joint-RPCA vs PCA vs NMF
# ------------------------------------------------------------------------------

joint_row <- bench_tbl %>%
    dplyr::filter(grepl("^Joint", model)) %>%
    dplyr::mutate(model_simple = "Joint-RPCA")

comp_rows <- if (exists("comp_tbl")) {
    comp_tbl %>%
        dplyr::mutate(
            model_simple = dplyr::case_when(
                grepl("^PCA", model) ~ "PCA",
                grepl("^NMF", model) ~ "NMF",
                TRUE ~ model
            )
        )
} else {
    data.frame()
}

cmp_all <- dplyr::bind_rows(
    joint_row %>% dplyr::select(model_simple, permanova_R2, AUROC),
    comp_rows %>% dplyr::select(model_simple, permanova_R2, AUROC)
) %>%
    dplyr::distinct() %>%
    dplyr::filter(model_simple %in% c("Joint-RPCA", "PCA", "NMF")) %>%
    dplyr::mutate(
        model_simple = factor(model_simple, levels = c("Joint-RPCA", "PCA", "NMF"))
    )

cmp_long <- tidyr::pivot_longer(
    cmp_all,
    cols = c(permanova_R2, AUROC),
    names_to = "metric",
    values_to = "value"
) %>%
    dplyr::filter(!is.na(value))



```
