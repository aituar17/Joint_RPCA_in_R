% \VignetteIndexEntry{IBDMDB — 2-Omic Joint-RPCA (MGX + MTX)}
% \VignetteEngine{knitr::rmarkdown}
% \VignetteEncoding{UTF-8}

---
title: "IBDMDB — 2-Omic Joint-RPCA (MGX + MTX)"
format: html
editor: visual
---

```{r setup, message = FALSE, warning = FALSE}
options(warn = -1)

#necessary imports
library(dplyr)
library(tidyr)
library(ggplot2)
library(mia)

# --------------------------------------------------------------------
#load packaged demo data
# --------------------------------------------------------------------

data(ibdmdb_2omic_demo)
suppressWarnings(data(ibdmdb_meta_demo))

#MultiAssayExperiment with MGX + MTX
mae_2 <- mae2

#extract assays (features x samples)
se_mgx <- mae_2[["MGX"]]
se_mtx <- mae_2[["MTX"]]

X_mgx <- SummarizedExperiment::assay(se_mgx, 1L)
X_mtx <- SummarizedExperiment::assay(se_mtx, 1L)

stopifnot(identical(colnames(X_mgx), colnames(X_mtx)))
sample_ids <- colnames(X_mgx)

# --------------------------------------------------------------------
#choose a safe rank k and run Joint-RPCA
# --------------------------------------------------------------------

per_view_min_dim <- sapply(list(X_mgx, X_mtx), function(m) min(nrow(m), ncol(m)))
k_max <- max(1L, min(per_view_min_dim))
k     <- min(3L, k_max)

message(sprintf(
    "[2-omic] per-view min dims = %s; using k = %d",
    paste(per_view_min_dim, collapse = ", "), k
))

set.seed(42)
mae_2 <- runJointRPCA(
    x                     = mae_2,
    n.components          = k,
    max.iterations        = 5,
    rclr.transform.tables = TRUE,
    min.sample.count      = 1,
    min.feature.count     = 0,
    min.feature.frequency = 0
)

fit2 <- metadata(mae_2)$JointRPCA[["JointRPCA"]]

# --------------------------------------------------------------------
#scores and loadings
# --------------------------------------------------------------------

U <- as.data.frame(fit2$ord.res$samples)
colnames(U) <- paste0("V", seq_len(ncol(U)))
U$sample_id <- rownames(U)

V_mgx <- mia:::.get_view(fit2$ord.res$features, c("MGX", "view_MGX", "view_mgx"))
V_mtx <- mia:::.get_view(fit2$ord.res$features, c("MTX", "view_MTX", "view_mtx"))

# --------------------------------------------------------------------
#attach IBD/non-IBD groups and plot ordination
# --------------------------------------------------------------------

meta_df <- if (exists("ibdmdb_meta_demo")) ibdmdb_meta_demo else NULL
grp_df  <- mia:::.make_groups_autodetect(meta_df, U$sample_id)

print(sort(table(grp_df$Group, useNA = "ifany")))

U2 <- dplyr::left_join(U, grp_df, by = "sample_id")
tab <- table(U2$Group, useNA = "ifany")
print(tab)

#PC1–PC2 colored by Group
ggplot(U2, aes(x = V1, y = V2, color = Group)) +
    geom_point(alpha = 0.85, size = 1.2) +
    labs(
        title = sprintf("Joint-RPCA (MGX + MTX), k = %d — PC1 vs PC2", k),
        x = "PC1", y = "PC2", color = NULL
    ) +
    theme_minimal()

# --------------------------------------------------------------------
#quick top-loadings on PC1 for each view
# --------------------------------------------------------------------

mia:::.show_top(V_mgx, "MGX")
mia:::.show_top(V_mtx, "MTX")

#label: session-info
sessionInfo()

```
